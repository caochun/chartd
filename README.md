# Chartd

## 问题


某商业公司提出"投标过程管理"需求：当公司业务代表通过招标信息发现商机之后，需要向公司汇报该商机，经公司领导审批通过后，执行投标过程，
并在后续过程中不断跟踪投标过程，直到成功或失败。 这个业务逻辑（或业务过程）可以用一个流程图或者一个状态转移图来建模，如下所示。


![](uml/logic.svg)

这一业务过程对应的是"投标"这一业务对象（按DDD[1]书中所述也可称作领域模型）的管理过程。我们可以将其建模为`Bid`、`Content`和`Addon`三个类型的一个聚合体（Aggregate）。如下图所示。

![](uml/model.svg)

> 上面这个模型只是一种选择，你也可以设计别的模型去表示一个"投标"对象。此外，一个业务过程也可以对应多个业务对象的管理，这些多个对象间可以存在或者不存在关系。
在后续介绍的应用框架设计都可以映射到这些情况上。我们在此用一个聚合类来举例并不失一般性。

在`Bid`这个领域模型之中我们还会实现一些领域逻辑，例如为`Bid`设置标题（`setTitle:String`）、设置审批通过状态(`setApproved:boolean`)、
更新内容(`setContent:Content`)或添加一个追踪记录(`addAddon:AddOn`）等。这些领域逻辑可以实现在`Bid`内，也可以在领域模型之上在封装一层服务(Service)。
这一`Bid`管理业务执行过程（我们称为`BidLogic`)就是按业务逻辑调用服务的过程，如下图所示。

![](uml/logic-coord.svg)

> 如果领域模型设计为多各类或者领域逻辑实现为多个服务，那业务过程就是依次调用多个服务的过程，或称为对领域对象进行协同协调的过程。我们在此用一个服务距离同样不失一般性。

通过这一协同过程投标过程管理的需求可得以实现。采用流程模型加流程引擎来实现这样的业务系统开发是当前企业应用开发中常见模式，我们可以采用主流的BPMN（或其他业务建模语言）对`BidLogic`这一的协同过程建模，
并在BPMN流程引擎中执行之。其中的各个节点可以实现为`ServiceTask`或者`UserTask`或者`ManualTask`等活动。前文中第一张业务流程图中包含了四个活动(`created`看成是初始状态无需活动干预)，
其中`editing`、`reviewing`和`tracking`需要用户参与（提供数据或一些额外的领域逻辑），例如editing状态下需要相关业务人员给定内容并调用服务层`setContent`方法完成一次编辑活动。

BPMN模型本身并没有给出规范如何让用户参与这些任务，不同的BPMN引擎实现给出了不同的扩展，例如在Activiti中可以通过扩展定义任务所指派的一个或多个执行者，
简单任务可以定义一个表单，复杂任务则通过任务监听器（`TaskListener`)实现将任务委托给外部代码执行。这两种方式在实际应用开发时都比较难以实现对该任务下对用户协同参与。
采用表单收集用户输入只将输入数据保存在流程实例对象中，缺乏直接机制再次调用服务方法传入数据；向外委托任务执行则需要开发一套独立的交互逻辑。

因此大多数情况下此类任务被建模为`ManualTask`更为合适，实际开发中业务过程可能成为下图所示。

![](uml/user-coord.svg)


在这种模式下，应用逻辑的执行在部分阶段中退化为一个被动的状态记录，而不是主动的协调者。参与业务逻辑执行过程中，用户作为主体需要重复获取应用状态、
根据状态主动调用其他服务驱动应用向前。 

简言之，现有的BPMN等流程模型所描述的应用逻辑执行过程并不适用于涉及人这样的主动实体的业务场景，这其中的根本原因在于我们在应用系统的领域模型中
单纯建立信息空间相关实体的模型，而缺乏针对物理空间和人的建模，导致流程引擎等业务逻辑执行体无法直接同时协同信息空间和现实空间的多元主体。

## 面向Actor的业务架构

如上所述，采用BPMN这类模型较为适合建模并执行可自动化（例如仅包含服务调用等）的业务逻辑，但面向涉及用户参与的业务时往往退化为一个活动划分或者状态记录模型时。
因此我们需要有更合适的软件抽象与架构来表达并实现业务逻辑运行中的业务实体协同（包括参与者及他们间的交互协议等）。

因业务逻辑本质上就是在某个应用领域中协同领域概念（领域模型与领域服务）以实现业务目标[1]，因此我们可以将所设计的领域概念及业务逻辑都建模为`Actor`[2]，
业务逻辑依靠Actor间发送并处理消息来推动执行。具体Actor模式概念与实现框架可以参考Akka[3]。前述投标管理逻辑可以Actor建模如下图所示。

![](uml/actor.svg)

投标管理业务`BidLogic`



![](uml/actor2.svg)


[//]: # (- 一个活动/状态下需要谁参与没有明确定义。应用逻辑执行的每个状态下需要执行的任务需要明确规约主客体；)

[//]: # (- 一个活动/状态下的参与者怎么协同没有明确定义。每个状态下的参与方之间的交互协议（输入什么输出什么）并不在应用逻辑中表达，如果涉及多个参与者他们间的关系缺乏明确表达和具体实施方法，例如"多数表决"如何表达并实施。)


[1] Evans, E. (2004). Domain-Driven Design: Tackling Complexity in the Heart of Software. Addison-Wesley.
[2] Hewitt, Carl; Bishop, Peter; Steiger, Richard (1973). "A Universal Modular Actor Formalism for Artificial Intelligence". IJCAI.
[3] How the Actor Model Meets the Needs of Modern, Distributed Systems. https://doc.akka.io/docs/akka/current/typed/guide/actors-intro.html